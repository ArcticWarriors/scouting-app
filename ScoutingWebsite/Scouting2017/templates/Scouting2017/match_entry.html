{% extends 'BaseScouting/base.html' %}
{% load staticfiles %}

{% block head %}
	<title>Match Entry - Arctic Warriors Scouting</title>
	
	<style>
		tr:nth-child(even) {background-color: #f2f2f2}
	</style>
	
	<script type="text/html" id="row-template"> 
		<tr>
			<!-- Match Info -->
			<td class="error_message-__i__" style="white-space: nowrap;"></td>
			<td><input type="number" id = "teamNumber" name="teamNumber-__i__" style="text-align:center;" onblur="validate_combination(__i__);"></td>
			<td><input type="number" id = "matchNumber" name="matchNumber-__i__" style="text-align:center;" onblur="validate_combination(__i__);"></td>

			<!-- Auto -->
			<td><input type="number" id = "autoGears" name="autoGears-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "autoFuelHighShot" name="autoFuelHighShot-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "autoFuelHighMade" name="autoFuelHighMade-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "autoFuelLowShot" name="autoFuelLowShot-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "autoFuelLowMade" name="autoFuelLowMade-__i__" value=0 style="text-align:center;"></td>
			<td style="text-align:center;"><input type="checkbox" id = "autoBaseline" name="autoBaseline-__i__" ></td>		

			<!-- Teleop -->
			<td><input type="number" id = "teleGears" name="teleGears-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "teleFuelHighShots" name="teleFuelHighShots-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "teleFuelHighScore" name="teleFuelHighScore-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "teleFuelLowShots" name="teleFuelLowShots-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "teleFuelLowScore" name="teleFuelLowScore-__i__" value=0 style="text-align:center;"></td>

			<!-- Endgame -->
			<td style="text-align:center;"><input type="checkbox" id = "ropeClimbed" name="ropeClimbed-__i__"></td>

			<!-- Fouls -->
			<td><input type="number" id = "fouls" name="fouls-__i__" value=0 style="text-align:center;"></td>
			<td><input type="number" id = "techFouls" name="techFouls-__i__" value=0 style="text-align:center;"></td>
			<td style="text-align:center;"><input type="checkbox" id = "yellowCard" name="yellowCard-__i__"></td>
			<td style="text-align:center;"><input type="checkbox" id = "redCard" name="redCard-__i__"></td>

			<!-- General -->
			<td style="text-align:center;"><input type="checkbox" id = "gathredGearFromGround" name="gathredGearFromGround-__i__"></td>
			<td style="text-align:center;"><input type="checkbox" id = "gathredFuelFromGround" name="gathredFuelFromGround-__i__"></td>
			<td><input type="number" id = "hoppersDumped" name="hoppersDumped-__i__" value=0 style="text-align:center;"></td>
			<td style="text-align:center;"><input type="checkbox" id = "playedDefense" name="playedDefense-__i__"></td>
			<td><textarea rows="1" cols="50" name="comments-__i__"></textarea></td>

			<!-- Maintenance -->
			<td><button type="button" class="btn btn-default" onclick="deleteRow(this)">Delete</button></td>
			<input type="hidden" id="rowCounter" name="rowCounter" value=__i__ style="text-align:center;">
		</tr>
	</script>
	
	<script type="text/javascript">
		i=0;
		function addRow(){
			i++;
			$("#entry-table tbody").append($("#row-template").html().replace(/__i__/g, i));
		}
	
		$(function(){
			addRow();
		});
	</script>

	<script type="text/javascript">
	function deleteRow(buttonel){
		$(buttonel).parent().parent().remove();
	}
	</script>
	

	<script type="text/javascript">

	available_teams = {{ teams|safe }};
	match_information = {{ matches|safe }};
	matches_to_scouted_teams = match_information['scouted']
	matches_to_unscouted_teams = match_information['unscouted']
	
	function validate_combination(i){

		team_input = $("[name='teamNumber-" + i + "']")
		match_input = $("[name='matchNumber-" + i + "']")
		error_column = $(".error_message-" + i)

		team_number = parseInt(team_input.val());
		match_number = parseInt(match_input.val());		
		
		if (isNaN(team_number) || isNaN(match_number))
		{
			return false
		}

		good_inputs = true
		if (!(team_number in available_teams))
		{
			error_column.css('background-color','red');
			error_column.html("Invalid Team Number")
			good_inputs = false
		}
		else if (match_number in matches_to_scouted_teams)
		{
			unscouted_teams = matches_to_unscouted_teams[match_number]
			scouted_teams = matches_to_scouted_teams[match_number]			
			
			in_scouted = jQuery.inArray(team_number, scouted_teams) !== -1
			in_unscouted = jQuery.inArray(team_number, unscouted_teams) !== -1

			if(in_scouted)
			{
				error_column.css('background-color','yellow');
				error_column.html("Team " + team_number + ", Match" + match_number + " has already been scouted")
				good_inputs = false
			}
			else if(!in_unscouted)
			{
				error_column.css('background-color','red');
				error_column.html("Team " + team_number + " is not in match " + match_number)
				good_inputs = false
			}
			else
			{
				error_column.css('background','transparent');
				error_column.html("")
				good_inputs = true
			}
		}
		else
		{
			error_column.css('background-color','red');
			error_column.html("Unknown error, team=" + team_number + ", match: " + match_number)
			good_inputs = false
		}
		
		return good_inputs
	}

	function validate_inputs(i){
		failed = false
		
          $('#entry-table > tbody  > tr').each(function(index)  {
              i = index + 1
              
              team_input = $("[name='teamNumber-" + i + "']")
              match_input = $("[name='matchNumber-" + i + "']")
              error_column = $(".error_message-" + i)
              team_number = parseInt(team_input.val());
              match_number = parseInt(match_input.val());
        
              if (isNaN(team_number) || isNaN(match_number))
              {
                  error_column.html("Need to enter match and team numbers")
                  error_column.css('background-color','red');
                  failed = true
              }
              else if(!failed)
              {
                  failed = !validate_combination(i)
              }
          })
          
          if(failed)
          {
              var submit = confirm("You have errors in your data, submit anyway?");
              if(submit)
              {
            	  failed = false
              }
          }
          
          return !failed
          
		};

		//$("#match_form").on("submit", validate_combination())

	</script>
{% endblock head %}

{% block content %}
	<div style="overflow-x: scroll;">
		<form action="{% url 'Scouting2017:submit_new_match' regional_code %}" method="post" onsubmit="return validate_inputs() ">
		{% csrf_token %}
		<table id="entry-table" class="table" style="margin: 0;">
			<thead>
				<tr>
						<!-- Match Info  -->
						<th></th>
						<th style="text-align:center;">Team Number</th>
						<th style="text-align:center;">Match Number</th>
						
						<!-- Auto  -->
						<th style="text-align:center;">Auto Gears</th>
						<th style="text-align:center;">Auto Fuel High Shots</th>
						<th style="text-align:center;">Auto Fuel High Made</th>
						<th style="text-align:center;">Auto Fuel Low Shots</th>
						<th style="text-align:center;">Auto Fuel Low Made</th>
						<th style="text-align:center;">Auto Baseline</th>
						
						<!-- Tele  -->
						<th style="text-align:center;">Tele Gears</th>
						<th style="text-align:center;">Tele High Fuel Shots</th>
						<th style="text-align:center;">Tele High Fuel Score</th>
						<th style="text-align:center;">Tele Low Fuel Shots</th>
						<th style="text-align:center;">Tele Low Fuel Score</th>

						<!-- Endgame -->
						<th style="text-align:center;">Climbing</th>
						
						<!-- Fouls -->
						<th style="text-align:center;">Fouls</th>
						<th style="text-align:center;">Tech Fouls</th>
						<th style="text-align:center;">Yellow Card</th>
						<th style="text-align:center;">Red Card</th>
						
						<!-- General -->
						<th style="text-align:center;">Gathered Gear From Ground</th>
						<th style="text-align:center;">Gathered Fuel From Ground</th>
						<th style="text-align:center;">Hoppers Dumped</th>
						<th style="text-align:center;">Played Defense</th>
						<th style="text-align:center;">Notes</th>
						
						<!-- Maintenance -->
						<th style="text-align:center;">Delete</th>
					</tr>
				</thead>
				<tbody>
				</tbody>	
			</table>
		</div>
		<button type="button" class="btn btn-default" onclick="addRow()">Add Row </button>
		<button type="submit" value="submit" class="btn btn-default">Submit </button>
		</form>
		
		
{% endblock content %}
